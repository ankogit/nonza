# TURN на 443 при одном IP с meet/ws/api: 443 слушает stream, по SNI
# turn.nonza.ru → TURN, остальное → HTTP на 8443. HTTP-серверы должны слушать 8443 ssl.
# Если у turn.nonza.ru отдельный IP — используй nginx-stream-turn-443-only.conf.
#
#   cp этот файл → /etc/nginx/streams-available/443-sni.conf
#   ln -s /etc/nginx/streams-available/443-sni.conf /etc/nginx/streams-enabled/

map $ssl_preread_server_name $backend {
  turn.nonza.ru  turn_internal;
  default        http_fallback;
}

upstream turn_internal {
  server 127.0.0.1:4430;
}

upstream http_fallback {
  server 127.0.0.1:8443;
}

server {
  listen 443;
  proxy_pass $backend;
  proxy_timeout 86400s;
  ssl_preread on;
}

# coturn на 10.50.0.118. Если coturn на этом же хосте — укажи 127.0.0.1:5349.
server {
  listen 127.0.0.1:4430 ssl;
  ssl_certificate     /etc/letsencrypt/live/turn.nonza.ru/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/turn.nonza.ru/privkey.pem;
  proxy_pass 10.50.0.118:5349;
  proxy_timeout 86400s;
}
